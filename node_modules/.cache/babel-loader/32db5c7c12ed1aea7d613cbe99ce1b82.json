{"ast":null,"code":"import { AuctioneerAuthorityRequiredError } from '../errors.mjs';\nimport { useOperation } from '../../../types/Operation.mjs';\nimport { now } from '../../../types/DateTime.mjs';\nimport { toPublicKey } from '../../../types/PublicKey.mjs';\nimport { TransactionBuilder } from '../../../utils/TransactionBuilder.mjs'; // -----------------\n// Operation\n// -----------------\n\nconst Key = 'DirectBuyOperation';\n/**\n * Creates a bid on a given asset and then executes a sale on the created bid and listing.\n *\n * ```ts\n * await metaplex\n *   .auctionHouse()\n *   .buy({ auctionHouse, listing, buyer };\n * ```\n *\n * @group Operations\n * @category Constructors\n */\n\nconst directBuyOperation = useOperation(Key);\n/**\n * @group Operations\n * @category Types\n */\n\n/**\n * @group Operations\n * @category Handlers\n */\n\nconst directBuyOperationHandler = {\n  handle: async (operation, metaplex, scope) => {\n    const builder = await directBuyBuilder(metaplex, operation.input, scope);\n    scope.throwIfCanceled();\n    return builder.sendAndConfirm(metaplex, scope.confirmOptions);\n  }\n}; // -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\n\n/**\n * Creates a bid on a given asset and executes a sale on the created bid and given listing.\n *\n * ```ts\n * const transactionBuilder = metaplex\n *   .auctionHouse()\n *   .builders()\n *   .buy({ auctionHouse, listing, buyer })\n * ```\n *\n * @group Transaction Builders\n * @category Constructors\n */\n\nconst directBuyBuilder = async function (metaplex, params) {\n  let options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n  // Data.\n  const {\n    programs,\n    payer = metaplex.rpc().getDefaultFeePayer()\n  } = options;\n  const {\n    auctionHouse,\n    auctioneerAuthority,\n    listing,\n    price = listing.price,\n    buyer = metaplex.identity(),\n    authority = auctionHouse.authorityAddress,\n    bookkeeper = metaplex.identity(),\n    createBidInstructionKey,\n    executeSaleInstructionKey\n  } = params;\n  const {\n    tokens,\n    asset,\n    sellerAddress,\n    receiptAddress\n  } = listing;\n  const printReceipt = (params.printReceipt ?? true) && Boolean(receiptAddress);\n\n  if (auctionHouse.hasAuctioneer && !auctioneerAuthority) {\n    throw new AuctioneerAuthorityRequiredError();\n  }\n\n  const bidBuilder = await metaplex.auctionHouse().builders().bid({\n    auctionHouse,\n    auctioneerAuthority,\n    authority,\n    tokens,\n    price,\n    mintAccount: asset.mint.address,\n    seller: sellerAddress,\n    buyer,\n    printReceipt,\n    bookkeeper,\n    instructionKey: createBidInstructionKey\n  }, {\n    programs,\n    payer\n  });\n  const {\n    receipt,\n    buyerTradeState\n  } = bidBuilder.getContext();\n  const bid = {\n    model: 'bid',\n    lazy: false,\n    auctionHouse,\n    asset,\n    tradeStateAddress: buyerTradeState,\n    bookkeeperAddress: bookkeeper.publicKey,\n    buyerAddress: buyer.publicKey,\n    receiptAddress: receipt,\n    purchaseReceiptAddress: null,\n    price,\n    tokens,\n    canceledAt: null,\n    createdAt: now(),\n    isPublic: false\n  };\n  const saleBuilder = metaplex.auctionHouse().builders().executeSale({\n    auctionHouse,\n    auctioneerAuthority,\n    bid,\n    listing,\n    printReceipt,\n    bookkeeper,\n    instructionKey: executeSaleInstructionKey\n  }, {\n    programs,\n    payer\n  });\n  const {\n    receipt: purchaseReceiptAddress\n  } = saleBuilder.getContext();\n  const buyerTokenAccount = metaplex.tokens().pdas().associatedTokenAccount({\n    mint: asset.address,\n    owner: toPublicKey(buyer),\n    programs\n  });\n  const purchasedAsset = { ...asset,\n    token: { ...asset.token,\n      address: buyerTokenAccount,\n      ownerAddress: toPublicKey(buyer)\n    }\n  };\n  const purchase = {\n    auctionHouse,\n    model: 'purchase',\n    lazy: false,\n    buyerAddress: toPublicKey(buyer),\n    sellerAddress,\n    asset: purchasedAsset,\n    bookkeeperAddress: toPublicKey(bookkeeper),\n    receiptAddress: purchaseReceiptAddress,\n    price: listing.price,\n    tokens,\n    createdAt: now()\n  };\n  return TransactionBuilder.make().setContext({\n    bid,\n    purchase\n  }).add(bidBuilder).add(saleBuilder);\n};\n\nexport { directBuyBuilder, directBuyOperation, directBuyOperationHandler };","map":{"version":3,"sources":["../../../../../src/plugins/auctionHouseModule/operations/directBuy.ts"],"names":["Key","directBuyOperation","useOperation","directBuyOperationHandler","handle","operation","metaplex","scope","builder","directBuyBuilder","input","throwIfCanceled","sendAndConfirm","confirmOptions","params","options","programs","payer","rpc","getDefaultFeePayer","auctionHouse","auctioneerAuthority","listing","price","buyer","identity","authority","authorityAddress","bookkeeper","createBidInstructionKey","executeSaleInstructionKey","tokens","asset","sellerAddress","receiptAddress","printReceipt","Boolean","hasAuctioneer","AuctioneerAuthorityRequiredError","bidBuilder","builders","bid","mintAccount","mint","address","seller","instructionKey","receipt","buyerTradeState","getContext","model","lazy","tradeStateAddress","bookkeeperAddress","publicKey","buyerAddress","purchaseReceiptAddress","canceledAt","createdAt","now","isPublic","saleBuilder","executeSale","buyerTokenAccount","pdas","associatedTokenAccount","owner","toPublicKey","purchasedAsset","token","ownerAddress","purchase","TransactionBuilder","make","setContext","add"],"mappings":";;;;4EAmBA;AACA;AACA;;AAEA,MAAMA,GAAG,GAAG,oBAAZ;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;MACaC,kBAAkB,GAAGC,YAAY,CAAqBF,GAArB,C;AAE9C;AACA;AACA;AACA;;AAmGA;AACA;AACA;AACA;;AACO,MAAMG,yBAA+D,GAAG;EAC7EC,MAAM,EAAE,OACNC,SADM,EAENC,QAFM,EAGNC,KAHM,KAIH;IACH,MAAMC,OAAO,GAAG,MAAMC,gBAAgB,CAACH,QAAD,EAAWD,SAAS,CAACK,KAArB,EAA4BH,KAA5B,CAAtC;IACAA,KAAK,CAACI,eAANJ;IAEA,OAAOC,OAAO,CAACI,cAARJ,CAAuBF,QAAvBE,EAAiCD,KAAK,CAACM,cAAvCL,CAAP;EACF;AAV6E,CAAxE,C,CAaP;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACaC,MAAAA,gBAAgB,GAAG,gBAC9BH,QAD8B,EAE9BQ,MAF8B,EAI2B;EAAA,IADzDC,OACyD,uEADpB,EACoB;EACzD;EACA,MAAM;IAAEC,QAAF;IAAYC,KAAK,GAAGX,QAAQ,CAACY,GAATZ,GAAea,kBAAfb;EAApB,IAA4DS,OAAlE;EACA,MAAM;IACJK,YADI;IAEJC,mBAFI;IAGJC,OAHI;IAIJC,KAAK,GAAGD,OAAO,CAACC,KAJZ;IAKJC,KAAK,GAAGlB,QAAQ,CAACmB,QAATnB,EALJ;IAMJoB,SAAS,GAAGN,YAAY,CAACO,gBANrB;IAOJC,UAAU,GAAGtB,QAAQ,CAACmB,QAATnB,EAPT;IAQJuB,uBARI;IASJC;EATI,IAUFhB,MAVJ;EAYA,MAAM;IAAEiB,MAAF;IAAUC,KAAV;IAAiBC,aAAjB;IAAgCC;EAAhC,IAAmDZ,OAAzD;EAEA,MAAMa,YAAY,GAAG,CAACrB,MAAM,CAACqB,YAAPrB,IAAuB,IAAxB,KAAiCsB,OAAO,CAACF,cAAD,CAA7D;;EAEA,IAAId,YAAY,CAACiB,aAAbjB,IAA8B,CAACC,mBAAnC,EAAwD;IACtD,MAAM,IAAIiB,gCAAJ,EAAN;EACF;;EAEA,MAAMC,UAAU,GAAG,MAAMjC,QAAQ,CAACc,YAATd,GAAwBkC,QAAxBlC,GAAmCmC,GAAnCnC,CACvB;IACEc,YADF;IAEEC,mBAFF;IAGEK,SAHF;IAIEK,MAJF;IAKER,KALF;IAMEmB,WAAW,EAAEV,KAAK,CAACW,IAANX,CAAWY,OAN1B;IAOEC,MAAM,EAAEZ,aAPV;IAQET,KARF;IASEW,YATF;IAUEP,UAVF;IAWEkB,cAAc,EAAEjB;EAXlB,CADuBvB,EAcvB;IAAEU,QAAF;IAAYC;EAAZ,CAduBX,CAAzB;EAgBA,MAAM;IAAEyC,OAAF;IAAWC;EAAX,IAA+BT,UAAU,CAACU,UAAXV,EAArC;EAEA,MAAME,GAAQ,GAAG;IACfS,KAAK,EAAE,KADQ;IAEfC,IAAI,EAAE,KAFS;IAGf/B,YAHe;IAIfY,KAJe;IAKfoB,iBAAiB,EAAEJ,eALJ;IAMfK,iBAAiB,EAAEzB,UAAU,CAAC0B,SANf;IAOfC,YAAY,EAAE/B,KAAK,CAAC8B,SAPL;IAQfpB,cAAc,EAAEa,OARD;IASfS,sBAAsB,EAAE,IATT;IAUfjC,KAVe;IAWfQ,MAXe;IAYf0B,UAAU,EAAE,IAZG;IAafC,SAAS,EAAEC,GAAG,EAbC;IAcfC,QAAQ,EAAE;EAdK,CAAjB;EAiBA,MAAMC,WAA0D,GAAGvD,QAAQ,CACxEc,YADgEd,GAEhEkC,QAFgElC,GAGhEwD,WAHgExD,CAI/D;IACEc,YADF;IAEEC,mBAFF;IAGEoB,GAHF;IAIEnB,OAJF;IAKEa,YALF;IAMEP,UANF;IAOEkB,cAAc,EAAEhB;EAPlB,CAJ+DxB,EAa/D;IAAEU,QAAF;IAAYC;EAAZ,CAb+DX,CAAnE;EAgBA,MAAM;IAAEyC,OAAO,EAAES;EAAX,IAAsCK,WAAW,CAACZ,UAAZY,EAA5C;EAEA,MAAME,iBAAiB,GAAGzD,QAAQ,CAC/ByB,MADuBzB,GAEvB0D,IAFuB1D,GAGvB2D,sBAHuB3D,CAGA;IACtBqC,IAAI,EAAEX,KAAK,CAACY,OADU;IAEtBsB,KAAK,EAAEC,WAAW,CAAC3C,KAAD,CAFI;IAGtBR;EAHsB,CAHAV,CAA1B;EAQA,MAAM8D,cAAc,GAAG,EACrB,GAAGpC,KADkB;IAErBqC,KAAK,EAAE,EACL,GAAGrC,KAAK,CAACqC,KADJ;MAELzB,OAAO,EAAEmB,iBAFJ;MAGLO,YAAY,EAAEH,WAAW,CAAC3C,KAAD;IAHpB;EAFc,CAAvB;EASA,MAAM+C,QAAkB,GAAG;IACzBnD,YADyB;IAEzB8B,KAAK,EAAE,UAFkB;IAGzBC,IAAI,EAAE,KAHmB;IAIzBI,YAAY,EAAEY,WAAW,CAAC3C,KAAD,CAJA;IAKzBS,aALyB;IAMzBD,KAAK,EAAEoC,cANkB;IAOzBf,iBAAiB,EAAEc,WAAW,CAACvC,UAAD,CAPL;IAQzBM,cAAc,EAAEsB,sBARS;IASzBjC,KAAK,EAAED,OAAO,CAACC,KATU;IAUzBQ,MAVyB;IAWzB2B,SAAS,EAAEC,GAAG;EAXW,CAA3B;EAcA,OAAOa,kBAAkB,CAACC,IAAnBD,GACJE,UADIF,CACO;IACV/B,GADU;IAEV8B;EAFU,CADPC,EAKJG,GALIH,CAKAjC,UALAiC,EAMJG,GANIH,CAMAX,WANAW,CAAP;AAOF,CAtHa/D","sourcesContent":["import { PublicKey } from '@solana/web3.js';\nimport { SendAndConfirmTransactionResponse } from '../../rpcModule';\nimport { AuctioneerAuthorityRequiredError } from '../errors';\nimport { AuctionHouse, Bid, Listing, Purchase } from '../models';\nimport { ExecuteSaleBuilderContext } from './executeSale';\nimport { TransactionBuilder, TransactionBuilderOptions } from '@/utils';\nimport {\n  now,\n  Operation,\n  OperationHandler,\n  OperationScope,\n  Signer,\n  SolAmount,\n  SplTokenAmount,\n  toPublicKey,\n  useOperation,\n} from '@/types';\nimport type { Metaplex } from '@/Metaplex';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'DirectBuyOperation' as const;\n\n/**\n * Creates a bid on a given asset and then executes a sale on the created bid and listing.\n *\n * ```ts\n * await metaplex\n *   .auctionHouse()\n *   .buy({ auctionHouse, listing, buyer };\n * ```\n *\n * @group Operations\n * @category Constructors\n */\nexport const directBuyOperation = useOperation<DirectBuyOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type DirectBuyOperation = Operation<\n  typeof Key,\n  DirectBuyInput,\n  DirectBuyOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type DirectBuyInput = {\n  /** The Auction House in which to create a Bid and execute a Sale. */\n  auctionHouse: AuctionHouse;\n\n  /**\n   * The Auction House authority.\n   * If this is Signer the transaction fee\n   * will be paid from the Auction House Fee Account\n   *\n   * @defaultValue `auctionHouse.authority`\n   */\n  authority?: PublicKey | Signer;\n\n  /**\n   * Creator of a bid.\n   * Should not be the same as seller who creates a Listing\n   *\n   * @defaultValue `metaplex.identity()`\n   */\n  buyer?: Signer;\n\n  /**\n   * The Listing that is used in the sale.\n   * We only need a subset of the `Listing` model but we\n   * need enough information regarding its settings to know how\n   * to execute the sale.\n   *\n   * This includes, its asset, auction house address, seller, receipt address etc.\n   */\n  listing: Pick<\n    Listing,\n    | 'asset'\n    | 'auctionHouse'\n    | 'canceledAt'\n    | 'price'\n    | 'sellerAddress'\n    | 'tokens'\n    | 'tradeStateAddress'\n    | 'receiptAddress'\n  >;\n\n  /**\n   * The buyer's price.\n   *\n   * @defaultValue `listing.price`.\n   */\n  price?: SolAmount | SplTokenAmount;\n\n  /**\n   * The Auctioneer authority key.\n   * It is required when Auction House has Auctioneer enabled.\n   *\n   * @defaultValue No default value.\n   */\n  auctioneerAuthority?: Signer;\n\n  /**\n   * The address of the bookkeeper wallet responsible for the receipt.\n   *\n   * @defaultValue `metaplex.identity()`\n   */\n  bookkeeper?: Signer;\n\n  /**\n   * Prints the purchase receipt.\n   * The receipt holds information about the purchase,\n   * So it's important to print it if you want to use the `Purchase` model\n   *\n   * @defaultValue `true`\n   */\n  printReceipt?: boolean;\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type DirectBuyOutput = {\n  /** A model that keeps information about the Bid. */\n  bid: Bid;\n\n  /** A model that keeps information about the Purchase. */\n  purchase: Purchase;\n\n  /** The blockchain response from sending and confirming the transaction. */\n  response: SendAndConfirmTransactionResponse;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const directBuyOperationHandler: OperationHandler<DirectBuyOperation> = {\n  handle: async (\n    operation: DirectBuyOperation,\n    metaplex: Metaplex,\n    scope: OperationScope\n  ) => {\n    const builder = await directBuyBuilder(metaplex, operation.input, scope);\n    scope.throwIfCanceled();\n\n    return builder.sendAndConfirm(metaplex, scope.confirmOptions);\n  },\n};\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type DirectBuyBuilderParams = Omit<DirectBuyInput, 'confirmOptions'> & {\n  createBidInstructionKey?: string;\n  executeSaleInstructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type DirectBuyBuilderContext = Omit<DirectBuyOutput, 'response'>;\n\n/**\n * Creates a bid on a given asset and executes a sale on the created bid and given listing.\n *\n * ```ts\n * const transactionBuilder = metaplex\n *   .auctionHouse()\n *   .builders()\n *   .buy({ auctionHouse, listing, buyer })\n * ```\n *\n * @group Transaction Builders\n * @category Constructors\n */\nexport const directBuyBuilder = async (\n  metaplex: Metaplex,\n  params: DirectBuyBuilderParams,\n  options: TransactionBuilderOptions = {}\n): Promise<TransactionBuilder<DirectBuyBuilderContext>> => {\n  // Data.\n  const { programs, payer = metaplex.rpc().getDefaultFeePayer() } = options;\n  const {\n    auctionHouse,\n    auctioneerAuthority,\n    listing,\n    price = listing.price,\n    buyer = metaplex.identity(),\n    authority = auctionHouse.authorityAddress,\n    bookkeeper = metaplex.identity(),\n    createBidInstructionKey,\n    executeSaleInstructionKey,\n  } = params;\n\n  const { tokens, asset, sellerAddress, receiptAddress } = listing;\n\n  const printReceipt = (params.printReceipt ?? true) && Boolean(receiptAddress);\n\n  if (auctionHouse.hasAuctioneer && !auctioneerAuthority) {\n    throw new AuctioneerAuthorityRequiredError();\n  }\n\n  const bidBuilder = await metaplex.auctionHouse().builders().bid(\n    {\n      auctionHouse,\n      auctioneerAuthority,\n      authority,\n      tokens,\n      price,\n      mintAccount: asset.mint.address,\n      seller: sellerAddress,\n      buyer,\n      printReceipt,\n      bookkeeper,\n      instructionKey: createBidInstructionKey,\n    },\n    { programs, payer }\n  );\n  const { receipt, buyerTradeState } = bidBuilder.getContext();\n\n  const bid: Bid = {\n    model: 'bid',\n    lazy: false,\n    auctionHouse,\n    asset,\n    tradeStateAddress: buyerTradeState,\n    bookkeeperAddress: bookkeeper.publicKey,\n    buyerAddress: buyer.publicKey,\n    receiptAddress: receipt,\n    purchaseReceiptAddress: null,\n    price,\n    tokens,\n    canceledAt: null,\n    createdAt: now(),\n    isPublic: false,\n  };\n\n  const saleBuilder: TransactionBuilder<ExecuteSaleBuilderContext> = metaplex\n    .auctionHouse()\n    .builders()\n    .executeSale(\n      {\n        auctionHouse,\n        auctioneerAuthority,\n        bid,\n        listing,\n        printReceipt,\n        bookkeeper,\n        instructionKey: executeSaleInstructionKey,\n      },\n      { programs, payer }\n    );\n\n  const { receipt: purchaseReceiptAddress } = saleBuilder.getContext();\n\n  const buyerTokenAccount = metaplex\n    .tokens()\n    .pdas()\n    .associatedTokenAccount({\n      mint: asset.address,\n      owner: toPublicKey(buyer),\n      programs,\n    });\n  const purchasedAsset = {\n    ...asset,\n    token: {\n      ...asset.token,\n      address: buyerTokenAccount,\n      ownerAddress: toPublicKey(buyer),\n    },\n  };\n\n  const purchase: Purchase = {\n    auctionHouse,\n    model: 'purchase',\n    lazy: false,\n    buyerAddress: toPublicKey(buyer),\n    sellerAddress,\n    asset: purchasedAsset,\n    bookkeeperAddress: toPublicKey(bookkeeper),\n    receiptAddress: purchaseReceiptAddress,\n    price: listing.price,\n    tokens,\n    createdAt: now(),\n  };\n\n  return TransactionBuilder.make<DirectBuyBuilderContext>()\n    .setContext({\n      bid,\n      purchase,\n    })\n    .add(bidBuilder)\n    .add(saleBuilder);\n};\n"]},"metadata":{},"sourceType":"module"}